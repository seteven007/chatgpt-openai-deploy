
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>AIæ¢è„¸ä¿®å¤ç‰ˆ</title>
  <style>
    body { background: #111; color: white; text-align: center; font-family: sans-serif; padding: 40px; }
    section { background: #222; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; margin: auto; }
    button { margin-top: 10px; padding: 10px 20px; border: none; background: #4ecdc4; color: white; border-radius: 6px; cursor: pointer; }
    img { margin-top: 20px; max-width: 100%; border-radius: 8px; }
    input { margin: 5px; }
  </style>
</head>
<body>
  <h1>ğŸ­ AIæ¢è„¸ï¼ˆä¿®å¤ä¸Šä¼ é—®é¢˜ï¼‰</h1>

  <section>
    <p>ä¸Šä¼ ä¸¤å¼ äººè„¸å›¾ç‰‡ï¼š</p>
    <input type="file" id="faceA" accept="image/*" />
    <input type="file" id="faceB" accept="image/*" />
    <br />
    <button onclick="uploadAndSwap()">ä¸Šä¼ å¹¶æ¢è„¸</button>
    <p id="swapStatus">ç­‰å¾…ä¸Šä¼ ...</p>
    <img id="faceResult" style="display:none;" />
  </section>

  <script>
    const uploadKey = "public_W23MTD3bzUbxT6pP6Z6eVZzharqQ";
    const replicateKey = "r8_RbeImSevv5mxwF6pNxETVBo6ROms3ra3erJRz";

    async function uploadFile(file) {
      try {
        const res = await fetch("https://api.upload.io/v2/accounts/uploadio/uploads/binary", {
          method: "POST",
          headers: { "Authorization": uploadKey },
          body: file
        });
        const data = await res.json();
        if (data?.fileUrl) return data.fileUrl;
        throw new Error("ä¸Šä¼ å¤±è´¥");
      } catch (e) {
        return null;
      }
    }

    async function pollResult(url) {
      while (true) {
        const res = await fetch(url, {
          headers: { "Authorization": "Token " + replicateKey }
        });
        const data = await res.json();
        if (data?.status === "succeeded") return data.output;
        if (data?.status === "failed") return null;
        await new Promise(r => setTimeout(r, 2000));
      }
    }

    async function uploadAndSwap() {
      const status = document.getElementById("swapStatus");
      const resultImg = document.getElementById("faceResult");
      const a = document.getElementById("faceA").files[0];
      const b = document.getElementById("faceB").files[0];
      if (!a || !b) return alert("è¯·ä¸Šä¼ ä¸¤å¼ äººè„¸å›¾ç‰‡");

      status.textContent = "â¬†ï¸ æ­£åœ¨ä¸Šä¼ ç¬¬1å¼ å›¾ç‰‡...";
      const urlA = await uploadFile(a);
      if (!urlA) return status.textContent = "âŒ ç¬¬1å¼ ä¸Šä¼ å¤±è´¥";

      status.textContent = "â¬†ï¸ æ­£åœ¨ä¸Šä¼ ç¬¬2å¼ å›¾ç‰‡...";
      const urlB = await uploadFile(b);
      if (!urlB) return status.textContent = "âŒ ç¬¬2å¼ ä¸Šä¼ å¤±è´¥";

      status.textContent = "ğŸ¤– æ­£åœ¨è°ƒç”¨ AI æ¢è„¸æ¨¡å‹...";

      const predict = await fetch("https://api.replicate.com/v1/predictions", {
        method: "POST",
        headers: {
          "Authorization": "Token " + replicateKey,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          version: "c43f6f013d7c4c13927a6212f96e4cf3d101f30be6509ff29468fddcbf7c8ef7",
          input: {
            target_image: urlA,
            source_image: urlB,
            mode: "face"
          }
        })
      });

      const data = await predict.json();
      if (!data?.urls?.get) return status.textContent = "âŒ æ¨¡å‹è°ƒç”¨å¤±è´¥";

      const outputUrl = await pollResult(data.urls.get);
      if (!outputUrl) return status.textContent = "âŒ æ¢è„¸å¤±è´¥";

      resultImg.src = outputUrl;
      resultImg.style.display = "block";
      status.textContent = "âœ… æ¢è„¸æˆåŠŸï¼";
    }
  </script>
</body>
</html>
